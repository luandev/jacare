name: Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run typecheck

      - name: Lint
        run: npm run lint

      - name: Run tests
        run: npm run test:unit

  test-packages:
    name: Test ${{ matrix.os }} package
    runs-on: ${{ matrix.os }}
    needs: checks
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            executable: jacare-linux
            platform: linux
          - os: windows-latest
            executable: jacare-win.exe
            platform: windows
          - os: macos-latest
            executable: jacare-macos
            platform: macos
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build package for current platform
        run: npm run package:bundle
        env:
          CI: false

      - name: Verify and test executable
        shell: bash
        run: |
          # Verify executable exists
          if [ ! -f "release/bundle/${{ matrix.executable }}" ]; then
            echo "Error: Executable not found"
            ls -la release/bundle/ || echo "Directory not found"
            exit 1
          fi
          
          # Make executable (Unix only)
          if [ "${{ matrix.platform }}" != "windows" ]; then
            chmod +x release/bundle/${{ matrix.executable }}
          fi
          
          # Create test environment
          mkdir -p test-data/logs
          export CROCDESK_DATA_DIR="$PWD/test-data"
          export CROCDESK_PORT=3334
          
          # Start server
          if [ "${{ matrix.platform }}" = "windows" ]; then
            ./release/bundle/${{ matrix.executable }} > test-output.log 2>&1 &
          else
            ./release/bundle/${{ matrix.executable }} > test-output.log 2>&1 &
          fi
          
          SERVER_PID=$!
          echo $SERVER_PID > server.pid
          
          # Wait for startup
          for i in {1..30}; do
            if curl -f http://localhost:3334/health > /dev/null 2>&1; then
              echo "✓ Server started successfully"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "Error: Server failed to start"
              cat test-output.log || true
              find test-data/logs -type f -exec cat {} \; 2>/dev/null || true
              kill $SERVER_PID 2>/dev/null || true
              exit 1
            fi
            sleep 1
          done
          
          # Basic smoke test
          curl -f http://localhost:3334/health
          curl -f http://localhost:3334/settings > /dev/null
          
          # Cleanup
          kill $SERVER_PID 2>/dev/null || true
          echo "✓ All tests passed for ${{ matrix.platform }}"

      - name: Upload artifact for release
        uses: actions/upload-artifact@v4
        with:
          name: bundle-${{ matrix.platform }}
          path: release/bundle/${{ matrix.executable }}
          retention-days: 1

  build:
    needs: test-packages
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Download tested artifacts
        uses: actions/download-artifact@v4
        with:
          path: release/bundle/
          pattern: bundle-*
          merge-multiple: true

      - name: Build workspace artifacts
        run: npm run build

      - name: Ensure 7zip-bin is ready
        shell: bash
        run: |
          # Ensure postinstall scripts have run
          echo "Rebuilding 7zip-bin to ensure binaries are available..."
          npm rebuild 7zip-bin || true
          
          # Verify binary exists for current platform
          if [ "${{ matrix.os }}" == "ubuntu-latest" ]; then
            if [ ! -f "node_modules/7zip-bin/linux/x64/7za" ]; then
              echo "7za binary missing for Linux, reinstalling 7zip-bin..."
              npm install 7zip-bin --force
              npm rebuild 7zip-bin
              if [ ! -f "node_modules/7zip-bin/linux/x64/7za" ]; then
                echo "Error: Failed to install 7za binary for Linux"
                ls -la node_modules/7zip-bin/linux/x64/ 2>/dev/null || echo "Directory does not exist"
                exit 1
              fi
            fi
            echo "✓ 7za binary verified for Linux"
          elif [ "${{ matrix.os }}" == "windows-latest" ]; then
            if [ ! -f "node_modules/7zip-bin/win/x64/7za.exe" ]; then
              echo "7za.exe binary missing for Windows, reinstalling 7zip-bin..."
              npm install 7zip-bin --force
              npm rebuild 7zip-bin
              if [ ! -f "node_modules/7zip-bin/win/x64/7za.exe" ]; then
                echo "Error: Failed to install 7za.exe binary for Windows"
                ls -la node_modules/7zip-bin/win/x64/ 2>/dev/null || echo "Directory does not exist"
                exit 1
              fi
            fi
            echo "✓ 7za.exe binary verified for Windows"
          elif [ "${{ matrix.os }}" == "macos-latest" ]; then
            if [ ! -f "node_modules/7zip-bin/mac/x64/7za" ]; then
              echo "7za binary missing for macOS, reinstalling 7zip-bin..."
              npm install 7zip-bin --force
              npm rebuild 7zip-bin
              if [ ! -f "node_modules/7zip-bin/mac/x64/7za" ]; then
                echo "Error: Failed to install 7za binary for macOS"
                ls -la node_modules/7zip-bin/mac/x64/ 2>/dev/null || echo "Directory does not exist"
                exit 1
              fi
            fi
            echo "✓ 7za binary verified for macOS"
          fi

      - name: Package desktop app
        shell: bash
        run: |
          cd apps/desktop
          echo "Packaging desktop app for ${{ matrix.os }}..."
          npm run package
          if [ $? -ne 0 ]; then
            echo "Error: Desktop app packaging failed"
            exit 1
          fi
          echo "✓ Desktop app packaged successfully"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Package server binary
        run: |
          cd apps/server
          npm run package

      - name: Package standalone bundle
        if: matrix.os == 'ubuntu-latest'
        run: |
          cd apps/server
          npm run build && pkg dist/index.js --targets node18-win-x64,node18-macos-x64,node18-linux-x64 --output-path ../../release/bundle/jacare

      - name: Upload desktop artifacts
        uses: actions/upload-artifact@v4
        with:
          name: desktop-${{ matrix.os }}
          path: release/desktop/*
          retention-days: 30

      - name: Upload server artifacts
        uses: actions/upload-artifact@v4
        with:
          name: server-${{ matrix.os }}
          path: release/server/*
          retention-days: 30

  create-release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create GitHub release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: Jacare v${{ github.run_number }}
          body_path: CHANGELOG.md
          files: |
            artifacts/**/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
