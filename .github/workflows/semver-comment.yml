name: Require semantic version comment

on:
  pull_request_target:
    types: [opened, reopened, synchronize, edited]
  issue_comment:
    types: [created, edited]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  semver-guard:
    if: github.event_name == 'pull_request_target' || (github.event_name == 'issue_comment' && github.event.issue.pull_request)
    runs-on: ubuntu-latest
    steps:
      - name: Enforce semantic version directive
        uses: actions/github-script@v7
        with:
          script: |
            let prNumber;
            if (github.event_name === 'issue_comment') {
              prNumber = github.event.issue?.number;
            } else if (github.event_name === 'pull_request_target') {
              prNumber = github.event.pull_request?.number;
            } else {
              core.setFailed(`Unexpected event type: ${github.event_name}`);
              return;
            }
            
            if (!prNumber) {
              core.setFailed('Could not determine pull request number from event');
              return;
            }

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              per_page: 100,
            });

            const hasDirective = comments.some((comment) => /\/semver:\s*(major|minor|patch)/i.test(comment.body || ''));
            const guidance = [
              '## âš ï¸ Missing Semantic Version Directive',
              '',
              'Please add a semantic version directive comment to this pull request.',
              '',
              '**Quick reference:**',
              '- `/semver: patch` - Bug fixes, minor changes',
              '- `/semver: minor` - New features (backward compatible)',
              '- `/semver: major` - Breaking changes',
              '',
              `ðŸ“– See [the semver comment template](/${context.repo.owner}/${context.repo.repo}/blob/main/.github/semver-comment-template.md) for detailed examples and guidelines.`,
            ].join('\n');

            if (!hasDirective) {
              const botComment = comments.find((comment) =>
                comment.user?.login === 'github-actions[bot]' && comment.body?.includes('semantic version directive comment')
              );

              if (!botComment) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: guidance,
                });
              }

              core.setFailed('Missing semantic version directive comment on pull request.');
            } else {
              core.notice('Semantic version directive comment found.');
            }
